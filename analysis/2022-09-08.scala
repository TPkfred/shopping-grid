// combined estreaming analysis

// this has lowest fare info, so is broken out by currency
val grid_out_dir = "/user/kendra.frederick/shop_vol/v4/raw/"
val df = spark.read.parquet(grid_out_dir)
// count: 11363097

val df_grp = (df.groupBy("outOriginAirport", "outDestinationAirport", "outDeptDt", "inDeptDt", "round_trip")
    .agg(sum("shop_counts").alias("sum_shop_counts"),
        countDistinct("currency").alias("curr_counts")
    )
)
// count: 3893890, ~34% of total

// currency counts:
df_grp.select(mean("curr_counts"), max("curr_counts")).show()
+------------------+----------------+                                           
|  avg(curr_counts)|max(curr_counts)|
+------------------+----------------+
|2.9181864408085487|              29|
+------------------+----------------+

// adding pcc to the groupby:
val df_pcc = spark.read.parquet("/user/kendra.frederick/shop_vol/v4_pcc/raw/")
// count: 26431546, 2.3x more than without

+----------------+---------------------+---------+--------+---------+---------+----------+-------------------+---------------+-----------+--------+--------+
|outOriginAirport|outDestinationAirport|outDeptDt|inDeptDt|      pos| currency|round_trip|                pcc|solution_counts|shop_counts|min_fare|searchDt|
+----------------+---------------------+---------+--------+---------+---------+----------+-------------------+---------------+-----------+--------+--------+
|       201855488|             34278144| 20220929|20221008|353566720|353567744|         1|2306408274154487808|            175|          5|  1117.3|20220906|
|       134943744|            319360512| 20220929|       0|117571584|117575680|         0|2236047110594101248|             20|          1|    95.1|20220906|
|       151195136|            219024384| 20221008|20221010|185729024|185734912|         1|2171895078174326784|           1277|         15|553500.0|20220906|
|       201855488|            202314496| 20221112|20221204|117571584|117575680|         1|2169628920284971008|            474|          2|  632.26|20220906|
|       134940416|             34278144| 20221222|20230101|134938624|134939648|         1|2600001952062373888|            120|          2|  3074.0|20220906|
|       319164160|            319684864| 20221107|20221114|353566720|353567744|         1|2091675860863025152|            412|         23|   207.2|20220906|
|       369823488|            152245248| 20221031|20221106|303366144|303366656|         1|2165975350520053760|           2701|         39|  3695.0|20220906|
|       201398272|            168168192| 20220907|20220924|353566720|353567744|         1|2525146122406592512|           1915|          7|  403.21|20220906|
|       152245248|            201791232| 20221207|20221210|353566720|353567744|         1| 799966177462845440|             10|          1|   320.8|20220906|
|        67962112|            218891520| 20221008|20221022|353566720|353567744|         1|  82225877571600384|            508|          9|  1161.0|20220906|
|       135857152|            201855488| 20221010|20221126|117571584|117575680|         1|1447379514618281984|            127|          3|  665.66|20220906|
|        34278144|            151195136| 20221224|20221228|336068608|336069120|         1|2090521249099808768|           1844|         12| 15965.0|20220906|
|       201855488|             67439616| 20221015|20221101|117571584|117575680|         1|2169628920284971008|            829|          9|  533.67|20220906|
|       252844288|             33754624| 20220923|       0|134938624|134939648|         0|2386347133180575744|            639|         29|   947.0|20220906|
|       201855488|            185863424| 20221016|       0|117571584|117575680|         0|2168785723715485696|            256|         27|  385.76|20220906|
|       201396992|            319423232| 20220918|       0|353566720|353567744|         0|2099525201359273984|           5549|        239|   248.6|20220906|
|        50595584|            151195136| 20221203|       0|353566720|353567744|         0|2306408274154487808|            483|         17|   558.8|20220906|
|        34540800|            403571200| 20230209|20230216|151912448|151917056|         1|2170475647317573632|           1100|          5| 10793.0|20220906|
|       318838528|            201855488| 20220918|20221012| 67436544| 85266944|         1|2387492811411816448|            245|        115|  100.56|20220906|
|        34278144|            201529600| 20220926|20220930|336068608|336069120|         1|2384672632806047744|             84|         22| 58950.0|20220906|
+----------------+---------------------+---------+--------+---------+---------+----------+-------------------+---------------+-----------+--------+--------+